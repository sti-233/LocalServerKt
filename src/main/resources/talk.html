<html>
    <head>
        <script>
            let nowTarget = null;

            let websocket = null;
            function connect() {
                const url = "ws://192.168.3.32:1919/message";
                websocket = new WebSocket(url);
                
                websocket.onopen = function(event) {
                    console.log("Connected to WebSocket server");
                };
                
                websocket.onmessage = function(event) {
                    addMessage(event.data);
                };
                
                websocket.onclose = function(event) {
                    console.log("Disconnected from WebSocket server");
                };
                
                websocket.onerror = function(error) {
                    console.log("Error: " + error);
                };
            }

            document.addEventListener('DOMContentLoaded',function() {
                renderHistory()
                connect()
            })

            async function announce() {
                if (document.getElementById('user').value != "") {return}
                ann = await fetch('/announce')
                ann = await ann.json()
                console.log(ann)
                annc = document.getElementById('ann')
                annc.appendChild(crtMsg(ann.sender,ann.time,ann.content))
            }

            function crtMsg(sender,time,content) {
                box = document.createElement('div')
                senderh = document.createElement('h2')
                timeh = document.createElement('p')
                contenth = document.createElement('p')
                senderh.textContent = sender
                timeh.textContent = time
                contenth.textContent = content
                box.appendChild(senderh)
                box.appendChild(timeh)
                box.appendChild(contenth)
                return box
            }

            function addMessage(str) {
                msg = JSON.parse(str);
                const Msgcontainer = document.getElementById("MsgBox");
                if (document.getElementById('user').value == msg.sendTo) {
                    newmsg = crtMsg(msg.name, msg.time, msg.text)
                    Msgcontainer.appendChild(newmsg)
                }
            }

            async function renderHistory() {
                MsgJson = await fetch('/history?targetuser='+document.getElementById('user').value)
                MsgJson = await MsgJson.json()
                console.log(MsgJson)
                Msgcontainer = document.getElementById("MsgBox")
                for (msg of MsgJson) {
                    console.log(msg)
                    newmsg = crtMsg(msg.name, msg.time, msg.text)
                    Msgcontainer.appendChild(newmsg)
                }
                end = document.getElementById('end')
                end.scrollIntoView({behavious: "smooth"})
            }
            
            async function sendMsg() {
                if (document.getElementById('user').value != nowTarget) {
                    await refresh()
                }
                text = document.getElementById('content').value
                user = document.getElementById('user').value
                json = '{ "text": "' + text + '", "target": "' + user + '" }'
                if (json && websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(json);
                    document.getElementById('content').value = "";
                }
            }

            async function refresh() {
                box=document.getElementById('MsgBox')
                box.innerHTML=''
                nowTarget = document.getElementById('user').value
                await renderHistory()
            }
        </script>
        <style>
            .scrollable{
                x:90%;
                overflow-y: auto;
                word-wrap: break-word;
            }
        </style>
    </head>
    <body>
        <h1>Talk</h1>
        <div id="ann" style="position: fixed;background-color: grey;"></div>
        <div id="MsgBox" class="scrollable"></div>
        <input type="text" id="content" placeholder="message...">
        <input type="text" id="user" placeholder="私聊对象，留空以在班级群发送">
        <button onclick="sendMsg()">send</button>
        <button onclick="refresh()">刷新私聊对象</button>
        <div id="end"></div>
    </body>
</html>